name: Build and Sign macOS App

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: read

env:
  APP_NAME: YouTrek
  XCODE_SCHEME: YouTrek

jobs:
  build-sign:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Create keychain and import signing certificate
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          CERT_P12_BASE64: ${{ secrets.SIGNING_CERTIFICATE }}
          CERT_P12_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          echo "$CERT_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$RUNNER_TEMP/cert.p12" -P "$CERT_P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Install provisioning profile (optional)
        env:
          PROFILE_BASE64: ${{ secrets.MACOS_PROVISIONING_PROFILE }}
        run: |
          set -euo pipefail
          if [ -n "${PROFILE_BASE64:-}" ]; then
            mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
            echo "$PROFILE_BASE64" | base64 --decode > "$HOME/Library/MobileDevice/Provisioning Profiles/profile.provisionprofile"
          fi

      - name: Build archive
        run: |
          set -euo pipefail
          xcodebuild \
            -project YouTrek.xcodeproj \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            archive

      - name: Export signed app
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          EXPORT_PLIST="$RUNNER_TEMP/ExportOptions.plist"
          cat > "$EXPORT_PLIST" <<PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>method</key>
  <string>developer-id</string>
  <key>signingStyle</key>
  <string>manual</string>
  <key>teamID</key>
  <string>${TEAM_ID}</string>
  <key>destination</key>
  <string>export</string>
  <key>signingCertificate</key>
  <string>Developer ID Application</string>
  <key>stripSwiftSymbols</key>
  <true/>
  <key>uploadSymbols</key>
  <false/>
</dict>
</plist>
PLIST

          xcodebuild \
            -exportArchive \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            -exportOptionsPlist "$EXPORT_PLIST" \
            -exportPath "$RUNNER_TEMP/export"

      - name: Notarize and staple
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          set -euo pipefail
          APP_PATH="$RUNNER_TEMP/export/${APP_NAME}.app"
          ZIP_PATH="$RUNNER_TEMP/${APP_NAME}.zip"

          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$ZIP_PATH"

          xcrun notarytool submit "$ZIP_PATH" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait

          xcrun stapler staple "$APP_PATH"

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: ${{ runner.temp }}/export/${{ env.APP_NAME }}.app
